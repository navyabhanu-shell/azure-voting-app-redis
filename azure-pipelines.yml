trigger:
- master

pr: none

variables:
  HELM_EXPERIMENTAL_OCI: 1
  ACR.Name: 'f2deskacrdev'
  Azure.ServiceConnection: 'F2D-NON-PRD-SVC'

stages:
- stage: build
  displayName: Build and Push
  jobs:  
  - job: job_helm
    displayName: Helm Publish
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      displayName: Login to Azure Container Registry
      inputs:
        azureSubscription: "$(Azure.ServiceConnection)"
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az acr login --name $(ACR.Name)
    - task: HelmInstaller@1
      inputs:
        helmVersionToInstall: 'latest'
    - bash: |
         helm package ./azure-vote/azure-vote-front --app-version $(Build.BuildNumber)
         mv *.tgz $(Build.ArtifactStagingDirectory)/
    - task: AzureCLI@1
      displayName: 'Push helm chart'
      inputs:
        azureSubscription: $(Azure.ServiceConnection)
        scriptLocation: inlineScript
        inlineScript: 'helm push $(Build.ArtifactStagingDirectory)/*.tgz oci://f2deskacrdev.azurecr.io/helm'
- stage: Deploy
  displayName: Deploy to aks cluster 
  dependsOn: build
  jobs:
  - job: job_helm_deploy
    displayName: Deploy to aks
    pool:
      vmImage: 'ubuntu-latest'
    steps:
              - task: HelmInstaller@0
                displayName: install helm
                inputs:
                  helmVersion: 'latest'
                  installKubectl: false

              - script: |
                  echo "$(acr.pull.password)" | helm registry login $(acr.name).azurecr.io --username $(acr.pull.username) --password-stdin
                displayName: login to acr using helm

              - bash: |
                    helm chart pull $(acr.name).azurecr.io/$(acr.repo.name):latest
                displayName: get helm chart on agent
              
              - bash: |
                  helm chart export $(acr.name).azurecr.io/$(acr.repo.name):latest --destination $(build.stagingdirectory)
                displayName: export the chart to folder
              
              - task: HelmDeploy@0
                displayName: deploy chart to aks
                inputs:
                  connectionType: 'Azure Resource Manager'
                  azureSubscription: '$(azure.service.connection)'
                  azureResourceGroup: 'demos'
                  kubernetesCluster: 'aksdemoutkarsh'
                  namespace: 'helmdemo'
                  command: 'upgrade'
                  chartType: 'FilePath'
                  chartPath: '$(build.stagingdirectory)/azure-vote/'
                  releaseName: 'helmdemo'
                  arguments: '--create-namespace --install'